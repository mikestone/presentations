<html>
  <head>
    <% duration "45:00" %>
    <%= stylesheet "prez" %>
  </head>

  <body>
    <% slide do %>
      <h2>Gemstash: A Tour + Lessons Learned</h2>

      <p>
        By MVS (Mike Virata-Stone)
      </p>

      <p class="smaller">
        @smellsblue on Twitter and GitHub
      </p>
    <% end %>

    <% slide do %>
      <h2>Part 1: A Tour</h2>
    <% end %>

    <% slide align: :left do %>
      <p>
        What exactly <em>is</em> Gemstash?
      </p>

      <ul>
        <% element tag: :li do %>It is a local gem server<% end %>
        <% element tag: :li do %>It caches gems from rubygems.org<% end %>
        <% element tag: :li do %>It caches gems from any other gem source<% end %>
        <% element tag: :li do %>It stores your own private gems<% end %>
      </ul>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Why use it?
      </p>

      <ul>
        <% element tag: :li do %>There are 113,324 distinct gems on rubygems.org<% end %>
        <% element tag: :li do %>With 626,317 versions<% end %>
        <% element tag: :li do %>There have been over 7,200,000,000 downloads<% end %>
        <% element tag: :li do %>Downloading all gem versions is about 120 GB<% end %>
        <% element tag: :li do %>90 gems downloaded per second at the non-peak hour of 12:30am early Monday morning<% end %>
      </ul>

      <% notes do %>
        <ul>
          <li>Public good, free service</li>
          <li>Heavy <strong>bandwidth</strong>, <strong>storage</strong>, and <strong>hosting</strong> toll</li>
          <li>Who <strong>pays</strong> for it all?</li>
        </ul>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Why use it?
      </p>

      <ul>
        <% element tag: :li do %>Rental Express has about 220 gems in our Gemfile<% end %>
        <% element tag: :li do %>Those gems total about 44 MB<% end %>
        <% element tag: :li do %>When bundling, each gem is fetched separately<% end %>
      </ul>

      <% notes do %>
        <ul>
          <li>Imagine bundling with a longer response time, like <strong>on the other side of the world</strong></li>
          <li>Imagine bundling on a <strong>spotty</strong> or <strong>slow connection</strong></li>
        </ul>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Bundling on every server of a service
      </p>

      <% notes do %>
        <p>
          Imagine if every company bundled against their own Gemstash server instead of using rubygems.org bandwidth
        </p>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        That's nice, but what's in it for me?
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Bundling Rails 4.2.5 against https://rubygems.org
      </p>

      <% element class: "pre smaller" do %>
$ time bundle
Fetching gem metadata from https://rubygems.org/...........
Fetching version metadata from https://rubygems.org/...
Fetching dependency metadata from https://rubygems.org/..
Installing rake 10.5.0
Installing i18n 0.7.0
...
Installing sprockets-rails 3.0.0
Installing rails 4.2.5
Bundle complete! 1 Gemfile dependency, 34 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.

real    1m41.089s
user    0m32.986s
sys     0m23.096s
      <% end %>

      <% notes do %>
        <p>
          Let's focus on the result of that
        </p>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Bundling Rails 4.2.5 against https://rubygems.org
      </p>

      <p class="pre smaller">
<strong>real    1m41.089s</strong>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        And now against Gemstash where all gems have been cached
      </p>

      <% element class: "pre smaller" do %>
$ time bundle
Fetching gem metadata from http://localhost:9292/...........
Fetching version metadata from http://localhost:9292/...
Fetching dependency metadata from http://localhost:9292/..
Installing rake 10.5.0
Installing i18n 0.7.0
...
Installing sprockets-rails 3.0.0
Installing rails 4.2.5
Bundle complete! 1 Gemfile dependency, 34 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.

real    0m54.471s
user    0m31.413s
sys     0m22.742s
      <% end %>

      <% notes do %>
        <p>
          Again, let's focus on the result of that
        </p>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        And now against Gemstash where all gems have been cached
      </p>

      <p class="pre smaller">
<strong>real    0m54.471s</strong>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Nokogiri takes a long time to build, so I tried again with Nokogiri preinstalled.
      </p>

      <% element class: "pre" do %><strong>rubygems.org:</strong>   real    0m32.879s<% end %>
      <% element class: "pre" do %><strong>Gemstash:</strong>       real    0m11.160s<% end %>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        Speed is nice, but what else?
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Show our version of multimap gem
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Show available versions of multimap gem
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        But wait, there's more...
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Show size of gems (image of person struggling to balance gems)
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Show size of jars (image of person struggling harder to balance gems + jars)
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Show size of .git objects directory
      </p>

      <% notes do %>
        <p>
          Talk about how we can remove gem files from our repo
        </p>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        How will this help with the jar situation?
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        The future of Gemstash: plugins (TODO: maybe gemstash with carrot + jars?)
      </p>

      <% notes do %>
        <p>
          Talk about plans to hook in jar caching and maybe more
        </p>

        <p>
          Maybe mention npm implementation
        </p>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        So how do you use Gemstash?
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Set it up, and start it
      </p>

      <p class="pre">
<% element tag: :span do %>$ gem install gemstash<% end %>
<% element tag: :span do %>$ gemstash start<% end %>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
source "https://rubygems.org"

gem "rails"

source "https://other-gem-server.org" do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
<strong>require "cgi"</strong>
source "https://rubygems.org"

gem "rails"

source "https://other-gem-server.org" do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
require "cgi"
source <strike>"https://rubygems.org"</strike>

gem "rails"

source <strike>"https://other-gem-server.org"</strike> do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
require "cgi"
source <strong>"http://localhost:9292"</strong>

gem "rails"

source <strong>"http://localhost:9292/upstream/" +
    CGI.escape("https://other-gem-server.org")</strong> do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Even better, keep your <strong>Gemfile</strong> as is, and use <strong>Bundler 1.11.2</strong>:
      </p>

      <p class="pre smaller">
<% element tag: :span do %>$ bundle config mirror.https://rubygems.org http://localhost:9292<% end %>
<% element tag: :span do %>$ bundle config mirror.https://other-gem-server.com http://localhost:9292<% end %>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        Questions?
      </p>

      <% notes do %>
        <p>Before we go into <strong>Part 2</strong>, any questions?</p>
      <% end %>
    <% end %>

    <% slide do %>
      <h2>Part 2: Lessons Learned</h2>
    <% end %>
  </body>
</html>
