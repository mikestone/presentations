<html>
  <head>
    <% duration "45:00" %>
    <%= stylesheet "prez" %>
  </head>

  <body>
    <% slide do %>
      <p>
        <%= image "gemstash" %>
      </p>

      <h2>A Tour + Lessons Learned</h2>

      <p>
        By MVS (Mike Virata-Stone)
      </p>

      <p class="smaller">
        @smellsblue on Twitter and GitHub
      </p>

      <% notes do %>
        <ul>
          <li>Special thanks to <strong>Jon</strong> for the awesome Gemstash logo!</li>
        </ul>
      <% end %>
    <% end %>

    <% slide do %>
      <h2>Part 1: A Tour</h2>
    <% end %>

    <% slide align: :left do %>
      <h3>What exactly <em>is</em> Gemstash?</h3>

      <ul>
        <% element tag: :li do %>It is a local gem server<% end %>
        <% element tag: :li do %>It caches gems from rubygems.org<% end %>
        <% element tag: :li do %>It caches gems from any other gem source<% end %>
        <% element tag: :li do %>It stores your own private gems<% end %>
      </ul>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <h3>Why use it?</h3>

      <ul>
        <% element tag: :li do %>There are <strong>113,324</strong> distinct gems on rubygems.org<% end %>
        <% element tag: :li do %>With <strong>626,317</strong> versions<% end %>
        <% element tag: :li do %>There have been over <strong>7,200,000,000</strong> downloads<% end %>
        <% element tag: :li do %>Downloading all gem versions is about <strong>120 GB</strong><% end %>
        <% element tag: :li do %><strong>90 gems</strong> downloaded <strong>per second</strong> at the non-peak hour of 12:30am early Monday morning<% end %>
      </ul>

      <% notes do %>
        <ul>
          <li>Public good, free service</li>
          <li>Heavy <strong>bandwidth</strong>, <strong>storage</strong>, and <strong>hosting</strong> toll</li>
          <li>Who <strong>pays</strong> for it all?</li>
        </ul>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <h3>Why use it?</h3>

      <ul>
        <% element tag: :li do %>Rental Express has about <strong>220</strong> gems in our Gemfile<% end %>
        <% element tag: :li do %>Those gems total about <strong>45 MB</strong><% end %>
        <% element tag: :li do %>When bundling, each gem is fetched separately<% end %>
      </ul>

      <% notes do %>
        <ul>
          <li>Imagine bundling with a longer response time, like <strong>on the other side of the world</strong></li>
          <li>Imagine bundling on a <strong>spotty</strong> or <strong>slow connection</strong></li>
        </ul>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        TODO: Bundling on every server of a service
      </p>

      <% notes do %>
        <p>
          Imagine if every company bundled against their own Gemstash server instead of using rubygems.org bandwidth
        </p>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>That's nice, but what's in it for me?</h3>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Bundling Rails 4.2.5 against https://rubygems.org
      </p>

      <% element class: "pre smaller" do %>
$ time bundle
Fetching gem metadata from https://rubygems.org/...........
Fetching version metadata from https://rubygems.org/...
Fetching dependency metadata from https://rubygems.org/..
Installing rake 10.5.0
Installing i18n 0.7.0
...
Installing sprockets-rails 3.0.0
Installing rails 4.2.5
Bundle complete! 1 Gemfile dependency, 34 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.

real    1m41.089s
user    0m32.986s
sys     0m23.096s
      <% end %>

      <% notes do %>
        <p>
          Let's focus on the result of that
        </p>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Bundling Rails 4.2.5 against https://rubygems.org
      </p>

      <p class="pre smaller">
<strong>real    1m41.089s</strong>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        And now against Gemstash where all gems have been cached
      </p>

      <% element class: "pre smaller" do %>
$ time bundle
Fetching gem metadata from http://localhost:9292/...........
Fetching version metadata from http://localhost:9292/...
Fetching dependency metadata from http://localhost:9292/..
Installing rake 10.5.0
Installing i18n 0.7.0
...
Installing sprockets-rails 3.0.0
Installing rails 4.2.5
Bundle complete! 1 Gemfile dependency, 34 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.

real    0m54.471s
user    0m31.413s
sys     0m22.742s
      <% end %>

      <% notes do %>
        <p>
          Again, let's focus on the result of that
        </p>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        And now against Gemstash where all gems have been cached
      </p>

      <p class="pre smaller">
<strong>real    0m54.471s</strong>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Nokogiri takes a long time to build, so I tried again with Nokogiri preinstalled.
      </p>

      <% element class: "pre" do %><strong>rubygems.org:</strong>   real    0m32.879s<% end %>
      <% element class: "pre" do %><strong>Gemstash:</strong>       real    0m11.160s<% end %>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>Speed is nice, but what else?</h3>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        In Rental Express:
      </p>

      <p>
        <span class="pre">multimap</span> gem, version: <span class="pre">1.1.2</span>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <p>
        <%= image "multimap-1", width: "50%", style: "position: absolute; z-index: 100; left: 25%; top: 10%;" %>
      </p>

      <% element do %>
        <%= image "multimap-2", width: "50%", style: "position: absolute; z-index: 200; left: 25%; top: 10%;" %>
      <% end %>

      <% element do %>
        <%= image "multimap-3", width: "50%", style: "position: absolute; z-index: 400; left: 25%; top: 10%;" %>
      <% end %>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>But wait, there's more...</h3>

      <% element do %>
        We have added <strong>1,889</strong> gem files in our master git history
      <% end %>

      <% element do %>
        (That's <strong>491,323,396</strong> bytes - <strong>491 MB</strong>)
      <% end %>

      <% element do %>
        We have added <strong>491</strong> jars in our master git history
      <% end %>

      <% element do %>
        (That's <strong>423,109,726</strong> bytes - <strong>423 MB</strong>)
      <% end %>

      <% notes do %>
        TODO: Show size of gems (image of person struggling to balance gems)<br />
        TODO: Show size of jars (image of person struggling harder to balance gems + jars)
      <% end %>
    <% end %>

    <% slide do %>
      <h3>So what?</h3>

      <% element do %>
        Our git repository is about <strong>1.5 GB</strong> (not including submodules)
      <% end %>

      <% element do %>
        Ripping these out of git would be <strong>2/3</strong> of our git repo size!!!
      <% end %>

      <% element do %>
        We have <strong>120 MB</strong> of active jars and <strong>45 MB</strong> of active gems
      <% end %>

      <% element do %>
        We are downloading and storing about <strong>750 MB</strong> of unneeded gems and jars!!!
      <% end %>

      <% notes do %>
        <p>
          Talk about how we can remove gem files from our repo
        </p>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>How will this help with the jar situation?</h3>

      <% element do %>
        The future of Gemstash:
      <% end %>

      <% element do %>
        Plugins!
      <% end %>

      <% notes do %>
        <ul>
          <li>TODO: maybe gemstash with carrot + jars?</li>
          <li>Talk about plans to hook in jar caching and maybe more</li>
          <li>Maybe mention npm implementation</li>
        </ul>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>So how do you use Gemstash?</h3>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Set it up, and start it
      </p>

      <p class="pre">
<% element tag: :span do %>$ gem install gemstash<% end %>
<% element tag: :span do %>$ gemstash start<% end %>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <% element tag: :p, class: "pre" do %>
source "https://rubygems.org"

gem "rails"

source "https://other-gem-server.org" do
  gem "other-gem"
end
      <% end %>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
<strong>require "cgi"</strong>
source "https://rubygems.org"

gem "rails"

source "https://other-gem-server.org" do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
require "cgi"
source <strike>"https://rubygems.org"</strike>

gem "rails"

source <strike>"https://other-gem-server.org"</strike> do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Update your <strong>Gemfile</strong>:
      </p>

      <p class="pre">
require "cgi"
source <strong>"http://localhost:9292"</strong>

gem "rails"

source <strong>"http://localhost:9292/upstream/" +
    CGI.escape("https://other-gem-server.org")</strong> do
  gem "other-gem"
end
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide align: :left do %>
      <p>
        Even better, keep your <strong>Gemfile</strong> as is, and use <strong>Bundler 1.11.2</strong>:
      </p>

      <p class="pre smaller">
<% element tag: :span do %>$ bundle config mirror.https://rubygems.org http://localhost:9292<% end %>
<% element tag: :span do %>$ bundle config mirror.https://other-gem-server.com http://localhost:9292<% end %>
      </p>

      <% notes do %>
      <% end %>
    <% end %>

    <% slide do %>
      <h3>Questions?</h3>

      <% notes do %>
        <p>Before we go into <strong>Part 2</strong>, any questions?</p>
      <% end %>
    <% end %>

    <% slide do %>
      <h2>Part 2: Lessons Learned</h2>
    <% end %>
  </body>
</html>
